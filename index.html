<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>OpenTrailMap by OpenStreetMap US</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
    <link href="css/reset.css" rel="stylesheet" />
    <link href="css/main.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" />
    <script type="module" src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <!-- attempt to load gitignored key in case this is dev environment -->
    <script type="application/javascript" src="api-keys.js"></script>
  </head>
  <body>
    <div id="header">
      <h1>OpenTrailMap</h1>
    </div>
    <div id="map"></div>
    <div id="controls">
      <select id="travel-mode">
        <option value="foot" selected>Hiking & Walking Trails</option>
        <option value="bicycle">Biking Trails</option>
        <option value="horse">Horseback Riding Trails</option>
      </select>
    </div>
    <script type="text/javascript">
      var mode = "foot";

      window.onload = (event) => {
        
        document.getElementById("travel-mode").onchange = function(e) {
          mode = e.target.value;
          updateLayers();
        }

        try {
          maptilerApiKey;
        } catch(e) {
            if(e.name == "ReferenceError") {
              // Use the production key if we didn't find a dev key (only works on OSM US domains)
              maptilerApiKey = "qe6b8locBISzDLGJweZ3";
            }
        }

        var map = new maplibregl.Map({
          container: 'map',
          hash: "map",
          style: 'https://api.maptiler.com/maps/dataviz/style.json?key=' + maptilerApiKey,
          center: [-97.9, 38.6],
          zoom: 3
        });

        var impliedYesHighways = {
          foot: [
            ["!=", ["get", "highway"], "path"],
            ["!=", ["get", "highway"], "footway"],
            ["!=", ["get", "highway"], "steps"],
            ["!=", ["get", "highway"], "bridleway"]
          ],
          bicycle: [
            ["!=", ["get", "highway"], "path"],
            ["!=", ["get", "highway"], "cycleway"],
            ["!=", ["get", "highway"], "bridleway"]
          ],
          horse: [
            ["!=", ["get", "highway"], "bridleway"]
          ]
        };

        function updateLayers() {

          var allFilter;

          if (mode === "bicycle" || mode === "horse") {
            allFilter =   
              ["any",
                ["all",
                  ["!=", "highway", "track"],
                  ["!=", "highway", "footway"],
                  ["!=", "highway", "steps"],
                ],
                ["has", "foot"],
                ["has", "bicycle"],
                ["has", "horse"]
              ];
          } else {
            allFilter = 
              ["any",
                ["!=", "highway", "track"],
                ["has", "foot"],
                ["has", "bicycle"],
                ["has", "horse"]
              ];
          }
          
          var unspecifiedExpression = ["any",
                  [
                    "all",
                    ["!", ["has", mode]],
                    ...impliedYesHighways[mode]
                  ]
                ];

          var allowedExpression = ["any",
            [
              "all",
              ["!", ["has", mode]],
              ["!=", ["get", "access"], "no"],
              ["!=", ["get", "access"], "private"],
              ["!=", ["get", "access"], "discouraged"]
            ],
            [
              "all",
              ["has", mode],
              ["!=", ["get", mode], "no"],
              ["!=", ["get", mode], "private"],
              ["!=", ["get", mode], "discouraged"]
            ]
          ];

          var lineColors = [
                "case",
                ["all", unspecifiedExpression, allowedExpression], "#ff3a00",
                unspecifiedExpression, "#a56c5b",
                allowedExpression, "#005908",
                "#a2d61d"
              ];
          var lineWidth = [
              "interpolate", ["linear"], ["zoom"],
              10, 1,
              22, 5
            ];
          
          map.setFilter('trails-labels', allFilter)
            .setFilter('trails-pointer-targets', allFilter)
            .setFilter('paths', [
              "all",
              allFilter,
              ["!=", "informal", true]
            ])
            .setFilter('informal', [
              "all",
              allFilter,
              ["==", "informal", true]
            ])
            .setPaintProperty('paths', 'line-width', lineWidth)
            .setPaintProperty('informal', 'line-width', lineWidth)
            .setPaintProperty('paths', 'line-color', lineColors)
            .setPaintProperty('informal', 'line-color', lineColors);
        }

        map.on('load', () => {
          map.addSource("trails", {
            type: "vector",
            url: "https://d1zqyi8v6vm8p9.cloudfront.net/trails.json",
            attribution: 'Â© <a href="https://openstreetmap.org">OpenStreetMap</a>'
          });

          var lineOpacity = [
              "interpolate", ["linear"], ["zoom"],
              10, 1,
              22, 0.4
            ];

          map.addLayer({
            "id": "paths",
            "source": "trails",
            "source-layer": "trail",
            "type": "line",
            "layout": {
              "line-cap": "butt",
              "line-join": "round"
            },
            "paint": {
              "line-opacity": lineOpacity
            }
          });
          map.addLayer({
            "id": "informal",
            "source": "trails",
            "source-layer": "trail",
            "type": "line",
            "layout": {
              "line-cap": "butt",
              "line-join": "round"
            },
            "paint": {
              "line-opacity": lineOpacity,
              "line-dasharray": [2, 2]
            }
          });
          map.addLayer({
            "id": "trails-labels",
            "source": "trails",
            "source-layer": "trail",
            "type": "symbol",
            "layout": {
              "text-field": ['get', 'name'],
              "text-size": 13,
              "symbol-placement": "line"
            },
            "paint": {
              "text-halo-width": 1,
              "text-halo-color": "#fff",
            }
          });
          map.addLayer({
            "id": "trails-pointer-targets",
            "source": "trails",
            "source-layer": "trail",
            "type": "line",
            "paint": {
                "line-color": "transparent",
                "line-width": 16
            }
          });

          updateLayers();
      });

      // Create a popup, but don't add it to the map yet.
      const popup = new maplibregl.Popup({
          closeButton: false,
          closeOnClick: false
      });

      map.on('mouseenter', 'trails-pointer-targets', (e) => {
          // Change the cursor style as a UI indicator.
          map.getCanvas().style.cursor = 'pointer';

          let desc = '';
          

          for (var key in e.features[0].properties) {
            desc += `${key}=${e.features[0].properties[key]}<br/>`;
          }

          const coordinates = e.lngLat.wrap();

          // Ensure that if the map is zoomed out such that multiple
          // copies of the feature are visible, the popup appears
          // over the copy being pointed to.
          while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
              coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
          }
          // Populate the popup and set its coordinates
          // based on the feature found.
          popup.setLngLat(coordinates).setHTML(desc).addTo(map);
      });

      map.on('click', 'trails-pointer-targets', (e) => {
          window.open('https://openstreetmap.org/way/'+e.features[0].id, "_blank");
      });

      map.on('mouseleave', 'trails-pointer-targets', () => {
          map.getCanvas().style.cursor = '';
          popup.remove();
      });
      }
    </script>
  </body>
</html>
